---
title: 新主机初始化脚本
date: 2020-09-10 10:25:54
tags: 
 - shell
categories: 
 - linux
 - shell
---
# 新主机初始化脚本

## 问题

> vps频繁更换，有些东西都需要从新安装一遍，费事，还容易忽略



## 脚本内容列表

- **安装 nodejs**
- **安装 jdk**
- **安装 autojump**
- **安装 trash-cli**
- **安装 busybox**
- **设置 vim 快捷键**
- **常用命令**
  - **git**
  - **wget**
  - **zsh**
  - **oh-my-zsh**
  - **docker**
  - **nginx**
- **设置时区**

## 准备工作

> 需要 **`shell`** 编程的知识

### 执行命令，结果保存到变量

 ```shell
v_node=$('命令')
 ```

### 判断命令是否安装

```shell
if [[ -x $(command -v 命令) ]]; 
```

> -x 判断文件是否有可执行权限

### 判断文件，文件夹是否存在

```shell
if [[ -d '/path' ]]; 
if [[ -f '/path' ]]; 
```

> -d 判断文件夹是否存在
>
> -f 判断文件是否存在
>
> ! 取反，注意要和 -d 、-f 、-x 隔一个空格，要不然会报 `unknown operan` 的错误

### if 、else 判断

```shell
if [[ "$v_trash" != "" ]]; then
        echo "0"
else
        echo '1'
fi
```

> [[ x ]] ; ：x 两边都需要有**空格**，后边如果跟 `then` ，需要有 ; 

### 定义方法

```shell
function xxx() {
    echo '1'
}
v_node=$(xxx)
###
function xxx() {
    v='$1'
}
v_node=$(xxx h)
```

> `shell` 的返回值是将标准输出返回给变量，注意方法中的输出 ，如果使用 `return` ，只能返回 `0 - 255` 的整数，使用 `echo $?` 获取
>
> 调用方法不需要括号
>
> 方法必须在使用前定义
>
> `$n` 是方法中取参数，n < 10，如果大于10，需要使用 ${10}




## 脚本

```shell
#!/bin/bash
res='/root/res'
zshrc='/root/.zshrc'
vimrc='/root/.vimrc'
echo '' > $res

function install_nodejs() {
    if [[ -x $(command -v node) ]]; then
        echo "node 已存在" >> $res
    else
        cd /usr/local
        wget https://nodejs.org/dist/v14.9.0/node-v14.9.0-linux-x64.tar.xz 
        tar -xvf node-v14.9.0-linux-x64.tar.xz 
        mv node-v14.9.0-linux-x64 nodejs
        echo 'export PATH=$PATH:/usr/local/nodejs/bin' >>/etc/profile
        source /etc/profile
        if [[ -x $(command -v node) ]]; then
            echo "node 安装成功"  >> $res
        else
            echo "node 安装失败"  >> $res
        fi
    fi
}
function install_jdk() {
    if [[ -x $(command -v java) ]]; then
        echo "jdk 已存在"  >> $res
    else
        yum install java-1.8.0-openjdk -y 
        if [[ $(command -v java) ]]; then
            echo "jdk 安装成功"  >> $res
        else
            echo "jdk 安装失败"  >> $res
        fi
    fi
}

function install_trashCli() {
    if [[ -x $(command -v trash-put) ]]; then
        echo "trash-cli 已存在"  >> $res
    else
        cd /usr/local
        git clone https://github.com/andreafrancia/trash-cli.git 
        cd trash-cli
        sudo python setup.py install 

        if [[ -x $(command -v trash-put) ]]; then
            echo "trash-cli 安装成功"  >> $res
        else 
            echo "trash-cli 安装失败"  >> $res
        fi
    fi
}


function install_autojumpCommand() {
    if [[ -x $(command -v autojump) ]]; then
        echo "autojump 已存在"  >> $res
    else
        cd /usr/local
        git clone git://github.com/joelthelion/autojump.git 
        cd autojump
        ./install.py 

        if [[ -x $(command -v autojump) ]]; then
            echo "autojump 安装成功"  >> $res
        else
            echo "autojump 安装失败"  >> $res
        fi
    fi
}

function install_ohMyZshCommand() {
    if [[ -d '/root/.oh-my-zsh' ]]; then
        echo "oh-my-zsh 已存在"  >> $res
    else
        wget https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O - | sh
        chsh -s /bin/zsh root 
        git clone https://github.com/zsh-users/zsh-autosuggestions $ZSH_CUSTOM/plugins/zsh-autosuggestions 
        git clone https://github.com/zsh-users/zsh-syntax-highlighting.git $ZSH_CUSTOM/plugins/zsh-autosuggestions 

        if [[ -d '/root/.oh-my-zsh' ]]; then
            echo "oh-my-zsh 安装成功"  >> $res
        else
            echo "oh-my-zsh 安装失败"  >> $res
        fi
    fi
}

function install_command() {
    if [[ -x $(command -v $1) ]]; then
        echo "$1 已存在"  >> $res
    else
        yum install -y $1 >
        if [[ -x $(command -v $1) ]]; then
            echo "$1 安装成功"  >> $res
        else
            echo "$1 安装失败"  >> $res
        fi
    fi
}
function install_busybox() {
    if [[ -x $(command -v busybox) ]]; then
        echo "busybox 已存在"  >> $res
    else
        cd /usr/local
        wget https://busybox.net/downloads/busybox-1.31.0.tar.bz2 
        tar -xjvf busybox-1.31.0.tar.bz2 
        cd /usr/local/busybox-1.31.0/
        make defconfig 
        make install 
        echo 'export PATH=/usr/local/busybox-1.31.0/_install/bin:$PATH' >>/etc/profie
        source /etc/profile
        if [[ -x $(command -v busybox) ]]; then
            echo "busybox 安装成功"  >> $res
        else
            echo "busybox 安装失败"  >> $res
        fi
    fi
}
function open_firewallPort() {
    firewall-cmd --zone=public --add-port=4000/tcp --permanent
    firewall-cmd --zone=public --add-port=443/tcp --permanent

}
function set_selinux() {
    cp /etc/selinux/config /etc/selinux/config.bak
    echo 'SELINUX=disabled' > /etc/selinux/config
    echo 'SELINUXTYPE=targeted' >> /etc/selinux/config
    setenforce 0
    
}
function set_vim() {
   if [ -f '/root/.vimrc' ]; then
    cp /root/.vimrc /root/.vimrc.bak
    echo ".vimrc文件存在，备份文件"  >> $res
    else
    touch $vimrc
   fi
   if [ ! -d '/root/.vim' ]; then
    mkdir -p /root/.vim/autoload
    cd /root/.vim/autoload
    wget https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
   fi
    echo "call plug#begin('~/.vim/plugged')" > $vimrc
    echo 'call plug#end()' >> $vimrc
    echo "let mapleader=' '" >> $vimrc
    echo 'nnoremap H ^' >> $vimrc
    echo 'nnoremap L $' >> $vimrc
    echo 'vnoremap H ^' >> $vimrc
    echo 'vnoremap L $' >> $vimrc
    echo 'map - Nzz' >> $vimrc
    echo 'map = nzz' >> $vimrc
    echo 'nnoremap <leader>l d$' >>$vimrc
    echo 'nnoremap <leader>h d0' >>$vimrc
    echo 'noremap <leader>w :w<CR>' >>$vimrc
    echo 'nnoremap <C-A> gg^vG$' >> $vimrc
    echo 'nnoremap <C-s> :w<CR>' >> $vimrc
    echo 'map <S-CR> $a<CR><ESC>' >> $vimrc
    echo 'noremap <leader>q :q!<CR>' >> $vimrc

 
}
function other() {
    timedatectl set-timezone Asia/Shanghai
    cp /root/.zshrc /root/.zshrc_bak
    echo '' > $zshrc
    echo 'export ZSH="/root/.oh-my-zsh"' >>$zshrc
    echo 'ZSH_THEME="ys"' >>$zshrc
    echo 'plugins=(git zsh-autosuggestions zsh-syntax-highlighting extract vi-mode)' >>$zshrc
    echo 'source $ZSH/oh-my-zsh.sh' >>$zshrc
    echo 'source "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"' >>$zshrc
    echo '[[ -s ~/.autojump/etc/profile.d/autojump.sh ]] && . ~/.autojump/etc/profile.d/autojump.sh' >>$zshrc
    echo 'alias rm="Please use <trash-put> command to delete file.";false' >>$zshrc
    echo "alias tp='trash-put'" >>$zshrc
    echo "alias tl='trash-list'" >>$zshrc
    echo "alias tr='trash-restore'" >>$zshrc
    echo "alias vi='vim'" >>$zshrc
    echo "alias src='source /etc/profile'" >>$zshrc
    echo "alias src='source $zshrc'" >>$zshrc
    source $zshrc

}
install_command git
install_command wget
install_command lsof
install_command bzip2
install_command zsh
install_command nginx
install_ohMyZshCommand
install_command gcc
install_autojumpCommand
install_jdk
install_nodejs
install_busybox
install_trashCli
install_command docker
other
set_selinux
set_vi
# git hexo


```
